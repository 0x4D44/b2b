# b2b Extension Requirements — 2025‑09‑28

## Overview
Extend `b2b` with four runtime modes: Orchestrator, Source, Sink, Mixer. Default scope is Linux on localhost using ALSA (`aplay`). SIP is implemented via `baresip` (UA + RTP). All roles run as separate `b2b` processes and communicate via SIP/RTP only; the Orchestrator supervises processes and aggregates logs.

## Review Feedback (summary)
- Clarify control path: Orchestrator supervision should use stdio pipes and POSIX signals (no custom RPC initially). Each child writes logs to stdout/stderr; Orchestrator prefixes with colored role tags and merges.
- Make audio/codec explicit: Default codec PCMU (G.711 µ‑law), 8 kHz mono, 20 ms `ptime` (50 packets/sec). Convert/generate PCM S16_LE internally.
- Define readiness/shutdown: Children print a single line handshake when ready and exit gracefully on SIGTERM within a deadline.
- Constrain network: Bind to `127.0.0.1` by default; explicit flags required to expose externally.
- Mixer DTMF: Start with in‑band DTMF tones mixed into PCM; add RFC2833 RTP events as a later enhancement.

## Modes & Responsibilities
- Sink (SIP “server”)
  - Binds `--sip-bind 127.0.0.1:5062` and accepts first incoming INVITE.
  - Decodes negotiated codec (default PCMU) to PCM S16_LE 8 kHz mono and pipes to `aplay` (`aplay -f S16_LE -r 8000 -c 1`).
- Source (SIP “client”)
  - Initiates call to `--target sip:127.0.0.1:5063`.
  - Reads `--audio-file sample.mp3`, decodes with prebuffer (≥1000 ms), and streams as continuous PCMU RTP with 20 ms frames.
- Mixer (dual UA)
  - Listens on `--sip-bind 127.0.0.1:5063` for a Source; concurrently dials `--target sip:127.0.0.1:5062` (the Sink).
  - Mixes incoming audio with a periodic local DTMF sequence (e.g., “123#”) generated as PCM; simple linear mix with headroom (scale 0.5 per source) to avoid clipping; emits to the Sink.
- Orchestrator
  - Launches child processes with role/ports and captures stdout/stderr.
  - Displays centralized logs with colored tags: [orch]=yellow, [source]=green, [mixer]=magenta, [sink]=blue (stable per PID).
  - Coordinates startup via readiness lines and controls shutdown.

## CLI & Configuration
Common flags (all roles):
```
--role <orchestrator|source|sink|mixer>
--sip-bind <ip:port>        # sink/mixer listener (default 127.0.0.1:0)
--target <sip-uri>          # source/mixer outbound target (e.g., sip:127.0.0.1:5062)
--log-format <text|json>    # child process output format (default text)
--color <auto|always|never> # ANSI colors (default auto)
```
Role‑specific:
```
source: --audio-file <path> --prebuffer-ms 1000 --ptime-ms 20 --codec pcmu
sink:   --aplay-cmd "aplay -f S16_LE -r 8000 -c 1"
mixer:  --dtmf-seq "123#" --dtmf-period-ms 2000 --mix-gain-in 0.5 --mix-gain-dtmf 0.5
orchestrator: --plan <file> --grace-ms 5000 --kill-ms 15000 --dry-run
```
Example plan (TOML):
```
[topology]
source.sip_target = "sip:YOUR_HOST_IP:5063"   # orchestrator auto-resolves
source.audio_file = "./assets/sample.mp3"

mixer.sip_bind   = "0.0.0.0:5063"
mixer.sip_target = "sip:YOUR_HOST_IP:5062"
mixer.dtmf_seq   = "+442083661177"

sink.sip_bind    = "0.0.0.0:5062"
```

## Lifecycle, Readiness, Shutdown
- Readiness: Each child prints a single line to stdout when ready:
```
READY role=<role> sip=<ip:port> codec=pcmu ptime=20ms
```
- Orchestrator waits for all READY lines (with timeout) before starting the Source call.
- Shutdown: Orchestrator sends SIGTERM to all children, waits `--grace-ms` for exit, then SIGKILL after `--kill-ms`.

## Logging
- Child log format (text): "<ts> <level> <role> <msg>"; children must avoid ANSI colors (Orchestrator adds tags/colors).
- Orchestrator output example:
```
[ORCH] ✓ started sink pid=1234
[SINK] listening sip=127.0.0.1:5062
[MIX ] dialing target=sip:127.0.0.1:5062
[SRC ] streaming file=sample.mp3 ptime=20ms
```
- Optional JSON: when `--log-format json`, each child writes structured lines; Orchestrator can pass‑through or reformat.

## Audio & Timing Requirements
- Codec: PCMU by default; negotiable list may include PCMA and L16 later.
- Sample rate: 8000 Hz; channels: mono; sample format: S16_LE internally.
- RTP: 20 ms frames; jitter buffer on receive ≥60 ms; source prebuffer ≥1000 ms to prevent gaps.
- Mixer: linear mixing with saturation protection; target RMS roughly matches input.

## Error Handling & Exit Codes
- `0` success; `64` invalid args/config; `65` SIP setup/connection failure; `66` audio I/O (aplay/decode) failure; `67` timeout (readiness/shutdown); `70` unexpected panic.
- Children log the terminal error before exit; Orchestrator summarizes failing role and exit code.

## Security & Network Defaults
- Bind to `127.0.0.1` by default; require `--sip-bind` override for external exposure.
- No auth/TLS in v1; document clearly in help text. Future: add digest auth and TLS.

## Observability
- Metrics (stdout or JSON): per role emit counters every 5s: `packets_tx`, `packets_rx`, `rtp_loss`, `jitter_ms_p50/p95`, `cpu_pct`.
- Orchestrator aggregates and prints a periodic one‑line summary.

## Minimal E2E Examples
- Manual start:
```
# Terminal 1
b2b --role sink --sip-bind 127.0.0.1:5062 --aplay-cmd "aplay -f S16_LE -r 8000 -c 1"
# Terminal 2
b2b --role mixer --sip-bind 127.0.0.1:5063 --target sip:127.0.0.1:5062 --dtmf-seq 123#
# Terminal 3
b2b --role source --target sip:127.0.0.1:5063 --audio-file ./sample.mp3
```
- Orchestrated:
```
b2b --role orchestrator --plan ./plans/sk.plan.toml     # source→sink
b2b --role orchestrator --plan ./plans/smk.plan.toml    # source→mixer→sink
```

## Test Plan (incremental)
- Unit: mp3 decode to PCM; DTMF tone generator; mixer gain and clipping unit tests.
- Integration (ignored by default): local loopback SIP call per role; assert READY and metrics monotonicity.
- E2E: orchestrator launches all roles; verify audio continuity (no packet gaps >40 ms in RTP timestamps) over 60 s.

## Open Questions
- Should CHILD also expose a simple control socket (UDS) for future live reconfiguration? (v1: no.)
- Do we require RFC2833 DTMF events in v1 or accept in‑band only? (v1: in‑band.)
- Additional codecs (PCMA/L16) in v1 or later? (later.)
