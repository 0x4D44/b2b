# b2b High‑Level Design (HLD) — 2025‑09‑28

## 1. Objective & Scope
Add four modes (Orchestrator, Source, Sink, Mixer) to `b2b` for local SIP/RTP audio pipelines using `baresip`. The Orchestrator supervises child `b2b` processes, aggregates logs, and coordinates lifecycle. Initial scope targets Linux, loopback by default, PCMU at 8 kHz, and ALSA playback via `aplay`.

Non‑goals (v1): network exposure by default, authentication/TLS, RFC2833 DTMF events, distributed control plane.

## 2. Architecture Overview
Processes
- Orchestrator: parent process that spawns N child `b2b` roles, reads their stdout/stderr, color‑tags and aggregates logs, enforces startup/shutdown timeouts, and (optionally) parses JSON metrics.
- Source: SIP client; decodes `sample.mp3` to PCM, resamples to 8 kHz if needed, encodes PCMU and sends RTP.
- Sink: SIP server; accepts INVITE, decodes PCMU to PCM and streams to `aplay` via stdin.
- Mixer: dual‑homed; server side accepts Source; client side calls Sink; mixes inbound PCM with periodic local DTMF PCM, encodes and sends to Sink.

Key Data Paths
- Control: Orchestrator ⇄ children via stdio (logs, readiness line) + POSIX signals for shutdown.
- Signaling/Media: SIP/RTP between roles using `baresip` (UA + `re`), confined to localhost by default.
- Audio: Source MP3 → decode → resample → PCMU encode → RTP; Sink RTP → PCMU decode → PCM → `aplay`; Mixer RTP(in) → PCM + DTMF PCM → mix → PCMU encode → RTP(out).

## 3. Module Decomposition (Rust)
Binary: `src/main.rs` (entry + role dispatch)
- `cli`: argument parsing (clap) and config/TOML plan loader.
- `orchestrator`: child process management, log aggregation, readiness/shutdown, summary.
- `role::source` | `role::sink` | `role::mixer`: per‑role runners implementing `Role` trait.
- `sip`: thin adapter over `baresip-rs` (UA setup, call create/answer, event handling, RTP media hooks).
- `media`: mp3 decode (symphonia), resample (linear or small FIR), DTMF generator, mixer, PCM ↔ PCMU helpers.
- `logging`: text and JSON emitters (children), color/tag logic (orchestrator).
- `metrics`: counters and periodic snapshots; JSON line schema.
- `util`: signals, time, bounded channels, subprocess helpers.

Trait
```
pub trait Role { fn run(self) -> anyhow::Result<()>; }
```

## 4. External Dependencies (proposed)
- `clap` (CLI), `anyhow` (errors), `thiserror` (typed errors), `owo-colors` (colors), `serde`/`serde_json` (metrics JSON),
- `symphonia` (mp3 decode), `rubato` or a simple custom resampler for 44.1k → 8k (start with linear; swap later),
- Existing: `baresip-rs` (+ `baresip-rs-sys` via vendored `re`/`baresip`).

## 5. Orchestrator Design
Child Model
- Launch via `std::process::Command`, `stdout/stderr` piped, one thread per stream reading lines (`BufRead::read_line`).
- Each child must print a single readiness line:
  `READY role=<role> sip=<ip:port> codec=pcmu ptime=20ms`
  Orchestrator waits for all required roles or timeouts.
- Shutdown: send SIGTERM; wait `--grace-ms`; if not exited, SIGKILL by `--kill-ms`.

Logs & Colors
- Tag map: ORCH=yellow, SOURCE=green, MIXER=magenta, SINK=blue. Tags are stable per PID and role.
- Line format (child text): `<ts> <level> <msg>`; Orchestrator prefixes `[ROLE]` and colors.
- Optional pass‑through JSON when `--log-format json`.

Plan File
- TOML (`--plan path`): defines per‑role ports/targets and file paths. Orchestrator derives command lines accordingly.

Backpressure & Robustness
- Bounded channel per child stream (e.g., 10k lines). On overflow, drop with a single warning per minute.
- Child exit detection: handle `wait()` in a supervisor thread; propagate exit code and cancel readers.

## 6. SIP/Media Adapter
- UA init via `BaresipContext::new_with_options` (core+UA) and `Reactor::start`.
- Source: create outbound call to target; attach a media source that pulls 20 ms PCM frames from a ring buffer filled by the decode/resample pipeline; `baresip` handles PCMU payload formatting.
- Sink: answer first INVITE; for each 20 ms frame received: decode to PCM, write to a `std::process::ChildStdin` for `aplay`.
- Mixer: server leg receives PCM; local DTMF generator produces PCM blocks; simple linear mixer `y = 0.5*in + 0.5*dtmf` with clamp; client leg encodes mixed PCM.
- Timers: 20 ms tick from reactor callback or a high‑rate audio thread coordinating with the UA buffer API.

## 7. Audio Pipeline
Decode
- Use `symphonia` to decode MP3 to f32/PCM; convert to i16; resample to 8 kHz mono (downmix if stereo: average L/R).
- Prebuffer: ≥1000 ms before starting RTP to avoid gaps; a bounded ring buffer (~2–4 s) tolerates short stalls.

Resample
- v1: linear interpolation; later: `rubato` for higher fidelity.

DTMF Generator
- Generate sine pairs for digits [0–9,*,#] with standard frequencies; duration per tone ~200 ms; pause 50 ms between; sequence repeats every `--dtmf-period-ms`.

Mixer
- 16‑bit saturation; apply per‑source gain to avoid clipping; expose `--mix-gain-*`.

## 8. CLI & Configuration
Common
```
--role <orchestrator|source|sink|mixer>
--sip-bind <ip:port>           # listener for sink/mixer (default 127.0.0.1:0)
--target <sip-uri>             # source/mixer outbound target
--log-format <text|json>
--color <auto|always|never>
```
Source
```
--audio-file <path> --prebuffer-ms 1000 --ptime-ms 20 --codec pcmu
```
Sink
```
--aplay-cmd "aplay -f S16_LE -r 8000 -c 1"
```
Mixer
```
--dtmf-seq "123#" --dtmf-period-ms 2000 --mix-gain-in 0.5 --mix-gain-dtmf 0.5
```
Orchestrator
```
--plan <file> --grace-ms 5000 --kill-ms 15000 --dry-run
```

## 9. Concurrency & State
- Each role spawns the `baresip` reactor thread; role logic runs on main thread.
- Source: decode/resample thread fills ring buffer; UA pull drains it; backpressure via bounded capacity; drop‑count metric if underrun.
- Sink: RTP receive callback enqueues to a small PCM queue flushed by a writer thread to `aplay` stdin.
- Mixer: two queues (inbound PCM, dtmf PCM); mixer thread combines on 20 ms cadence.
- Orchestrator: supervisor thread for child lifecycle + per‑pipe reader threads.

## 10. Readiness & Health
- READY line emitted when: UA initialized, bind/dial prepared, buffers primed (Source prebuffer reached), and `aplay` child open (Sink).
- Liveness: periodic metrics line every 5s including packet/byte counters; zero change for two periods flags stalled.

## 11. Error Handling & Exit Codes
- Mapped exit codes: 0 OK; 64 invalid args; 65 SIP setup/connection; 66 audio I/O; 67 readiness/shutdown timeout; 70 panic.
- Children log terminal error; Orchestrator prints a summary and returns non‑zero if any child failed.

## 12. Security & Defaults
- Bind to `127.0.0.1` unless explicitly overridden. No auth/TLS in v1; warn when binding non‑loopback.
- No external files executed except configured `aplay` binary.

## 13. Performance Targets
- End‑to‑end latency (Source→Sink): < 250 ms on localhost (includes 1 s source prebuffer startup only).
- Jitter buffer: ≥60 ms effective at receive; no gaps > 40 ms (RTP ts delta).
- CPU: < 10% on typical dev machine for 1 pipeline (guideline).

## 14. Observability
- Text logs suitable for humans; optional JSON lines for tools.
- Metrics schema (JSON): `{ts, role, pid, packets_tx, packets_rx, rtp_loss, jitter_ms_p50, jitter_ms_p95, cpu_pct}`.
- Orchestrator prints a 5s summary rollup.

## 15. Packaging & Build
- Static vendored `re`/`baresip` via existing `[patch.crates-io]` and `.cargo/config.toml` env.
- Commands
  - `cargo run -- --role sink --sip-bind 127.0.0.1:5062 --aplay-cmd "aplay -f S16_LE -r 8000 -c 1"`
  - `cargo run -- --role mixer --sip-bind 127.0.0.1:5063 --target sip:127.0.0.1:5062 --dtmf-seq 123#`
  - `cargo run -- --role source --target sip:127.0.0.1:5063 --audio-file ./sample.mp3`
  - `cargo run -- --role orchestrator --plan ./designs/example.plan.toml`

## 16. Testing Strategy
- Unit tests: mp3 decode shim, resampler correctness (impulse/step), DTMF tone frequencies, mixer saturation.
- Integration: role startup on loopback; READY contract; RTP timestamps monotonic; audio continuity over 60 s.
- Orchestrator: simulate children via fixtures that emit READY + logs; verify coloring, timeouts, and shutdown.
- CI (future): matrix with `--no-default-features` to ensure minimal footprint.

## 17. Risks & Mitigations
- MP3 → 8 kHz quality: start with linear resample; mitigate with optional `rubato` later.
- `aplay` portability: gate by CLI; detect absence and fail fast with code 66.
- Baresip integration nuances: keep adapter thin; rely on reactor callbacks and tested vendor crates.
- Log flooding: bound channels; rate‑limit overflow warnings.

## 18. Implementation Plan (Phased)
1) Scaffolding: CLI, role dispatch, logging, exit codes, READY line (no SIP yet).
2) Sink: `aplay` writer + UA listen/answer + PCMU decode.
3) Source: mp3 decode/resample/prebuffer + UA dial + PCMU send.
4) Mixer: dual UA legs + DTMF + linear mixing.
5) Orchestrator: spawn children, aggregate logs, readiness/barriers, graceful shutdown.
6) Metrics/summary + JSON option; stabilization; docs and examples.

## 19. Open Questions (carryover)
- Control socket (UDS) for live reconfigure? Not in v1.
- RFC2833 DTMF events? Later.
- Extra codecs (PCMA/L16)? Later.

